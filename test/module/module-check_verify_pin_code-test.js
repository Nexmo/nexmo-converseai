/**
 * @file test/module-check_verify_pin_code-test.js
 * @author leggetter@vonage.com
 * @description Check a Nexmo Verification Pin Code 
 *
 * Generated by the converse-cli tool for use with the Converse AI
 * Plugins SDK. https://developers.converse.ai/
 */

const request     = require('supertest');
const expect      = require('chai').expect;
const server      = require('../lib/express');
const readline    = require('readline');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

const testConfig = require('../test-config');
const NexmoBuilder = require('../../converseai_modules/NexmoBuilder');

describe('Check Verify Pin Code', function () {

  let pinCodeToCheck = null;
  let requestId = null;

  beforeEach((done) => {
    const nexmo = NexmoBuilder.build(testConfig.registrationData);

    nexmo.verify.request({
      number: testConfig.to_number,
      brand: 'ConverseTest'
    }, (error, result) => {
      if(error) {
        console.error(error);
        throw error;
      }
      else {
        rl.question('What PIN code did you receive? ', (answer) => {

          pinCodeToCheck = answer;
          requestId = result.request_id;
          
          console.log('Thanks!');
        
          rl.close();

          console.log('calling done');
          done();
        }); 
      }
    });

  });

  it('base', function(done) {

    request(server)
      .post('/')
      .send({
        event: 'MODULE_EXEC',
        payload: {
          moduleId: 'check_verify_pin_code',
          moduleParam: {
            request_id: requestId,
            pin_code: pinCodeToCheck
          },
          registrationData: testConfig.registrationData
        }
      })
      .set('X_CONVERSE_APP_TOKEN', require('../../app-token'))
      .expect(200)
      .end(function(err, res) {
        expect(res.body).to.have.property('status').to.equal(0);
        expect(res.body).to.have.property('value');
        done();
      });
  })

});
