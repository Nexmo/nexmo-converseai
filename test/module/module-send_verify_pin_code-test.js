/**
 * @file test/module-send_verify_pin_code-test.js
 * @author leggetter@vonage.com
 * @description Send a Verify pin code to start the phone number 
 * verification process 
 *
 * Generated by the converse-cli tool for use with the Converse AI
 * Plugins SDK. https://developers.converse.ai/
 */

const request     = require('supertest');
const expect      = require('chai').expect;
const server      = require('../lib/express');

const testConfig = require('../test-config');
const NexmoBuilder = require('../../converseai_modules/NexmoBuilder');

let request_id = null;

describe('Send Verify Pin Code', function () {

  it('base', function(done) {

    request(server)
      .post('/')
      .send({
        event: 'MODULE_EXEC',
        payload: {
          moduleId: 'send_verify_pin_code',
          moduleParam: {
            number: testConfig.to_number,
            country: undefined,
            brand: 'ConverseTest',
            sender_id: undefined,
            code_length: undefined,
            language: undefined,
            restrict_network_type: undefined,
            pin_expiry: undefined,
            next_event_wait_seconds: undefined
          },
          registrationData: testConfig.registrationData
        }
      })
      .set('X_CONVERSE_APP_TOKEN', require('../../app-token'))
      .expect(200)
      .end(function(err, res) {
        expect(res.body).to.have.property('status').to.equal(0);
        expect(res.body).to.have.property('value');

        request_id = res.body.value.request_id;

        done();
      });
  });

  after((done) => {
    if(request_id) {
      console.log('waiting 30 seconds to cancel Verify request');
      setTimeout(() => {
        const nexmo = NexmoBuilder.build(testConfig.registrationData);
        
        nexmo.verify.control({
          request_id: request_id,
          cmd: 'cancel'}, (error, result) => {
            if(error) {
              console.error(error);
            }
            console.log(result);
            done();
          });
        }, 30000);

    }
    else {
      done();
    }
  });

});
